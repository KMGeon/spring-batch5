# Job

## JobBuilder
- JobBuilderëŠ” Jobì„ ìƒì„±í•˜ì§€ ì•Šê³  ì‹¤ì œ Job ìƒì„±ì„ ìœ„ì„í•œë‹¤.
  - SimpleJobBuilder
  - FlowJobBuilder

![img.png](img/3/img.png)

## SimpleJob
- SimpleJobì€ SimpleJobBuilderì— ì˜í•´ì„œ ìƒì„±ë˜ë©° ì—¬ëŸ¬ ë‹¨ê³„ì˜ Stepì„ ê°€ì§ˆ ìˆ˜ ìˆê³  ìˆœì°¨ì ìœ¼ë¡œ Stepì„ ì‹¤í–‰ì„ ì‹œí‚¨ë‹¤.
- ëª¨ë“  Stepì´ ì„±ê³µì´ ë˜ì–´ì•¼ì§€ Jobì´ ì„±ê³µëœë‹¤.
- ë§¨ ë§ˆì§€ë§‰ì— ì²˜ë¦¬ëœ Stepì˜ BatchStatusê°€ Jobì˜ Statusê°€ ëœë‹¤.

```java
@Bean
public Job simpleStepJob() throws Exception {
    return new JobBuilder("simpleStepJob", jobRepository)
            .start(simpleStepExecutionStep())
            .next(simpleStepExecutionStep_2())
            .incrementer() // ì¡ íŒŒë¼ë¯¸í„°ì˜ IDë¥¼ ìë™ìœ¼ë¡œ ì¦ê°€ì‹œí‚¨ë‹¤.
            .preventRestart() // Jobì˜ ì¬ì‹œì‘ ì—¬ë¶€ë¥¼ ì„¤ì •í•œë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ True
            .validator() // JobParameterë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— ì˜¬ë°”ë¥¸ì§€ ì²´í¬í•œë‹¤.
            .listener() // ì½œë°±ë°›ì•„ ë¦¬ìŠ¤ë„ˆ ì²˜ë¦¬ë¥¼ í•œë‹¤.
            .build();
}
```

### preventRestart
- JobInstanceê°€ ê°™ì„ ë•Œ ì¬ì‹œì‘ì„ ë§‰ëŠ”ë‹¤. 
- ê¸°ë³¸ì ìœ¼ë¡œ trueë¡œ ì„¤ì •ì´ ë˜ì–´ì„œ ì¬ì‹œì‘ì´ ê°€ëŠ¥í•˜ì§€ë§Œ í•´ë‹¹ APIë¥¼ ì¶”ê°€ë¥¼ í•˜ê²Œ ëœë‹¤ë©´ ì¬ì‹œì‘ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

### ìƒí™©
1. step1,2ê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê³  step2ì—ì„œ exceptionì´ ë°œìƒí–ˆë‹¤.
2. preventRestartë¥¼ ì„¤ì •í•œë‹¤.
3. ì´ì „ì—ëŠ” ì‹¤íŒ¨í•œ step2ë¥¼ ì‹¤í–‰í•˜ì§€ë§Œ ì§€ê¸ˆì€ ë‹¤ìŒê³¼ ê°™ì€ exceptionì´ ë°œìƒí•œë‹¤.
```java
2024-10-16 10:51:09 [ERROR] [] [] Application run failed
java.lang.IllegalStateException: Failed to execute ApplicationRunner
at org.springframework.boot.SpringApplication.lambda$callRunner$6(SpringApplication.java:797)
at org.springframework.util.function.ThrowingConsumer.accept(ThrowingConsumer.java:66)
at org.springframework.util.function.ThrowingConsumer$1.accept(ThrowingConsumer.java:88)
at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:798)
at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:786)
at org.springframework.boot.SpringApplication.lambda$callRunners$3(SpringApplication.java:774)
at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)
```

### Validator
- Job ì‹¤í–‰ì— ê¼­ í•„ìš”í•œ íŒŒë¼ë¯¸í„°ë¥¼ ê²€ì¦í•˜ëŠ” ìš©ë„
- `DefaultJobParametersValidator` êµ¬í˜„ì²´ë¥¼ ì§€ì›í•˜ë©° ë” ë³µì¡í•œ ì œì•½ì¡°ê±´ì´ ìˆìœ¼ë©´ ì§ì ‘ êµ¬í˜„
- `reqiredKeys` : ë°˜ë“œì‹œ í•„ìš”í•œ key / `optionalKeys` : ì˜µì…˜
-

```java
public class SimpleJob extends AbstractJob
private JobParametersValidator jobParametersValidator = new DefaultJobParametersValidator();

```

- 2ë²ˆì˜ ê²€ì¦ì„ í•˜ê²Œ ëœë‹¤.
    - SimpleJobLancherì—ì„œ ê²€ì¦SimpleJobì˜ ìƒìœ„ `AbstractJob`ì—ì„œ ê²€ì¦

```java
@Component
class CustomJobParamValidator implements JobParametersValidator{

    @Override
    public void validate(JobParameters parameters) throws JobParametersInvalidException {
        if (parameters.getString("name") == null)
            throw new JobParametersInvalidException("name parameters is
    }
}
```

# Step

## StepBuilder
- Stepì„ êµ¬ì„±í•˜ëŠ” ì„¤ì • ì¡°ê±´ì— ë§ê²Œ í•˜ìœ„ ë¹Œë” í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ì‹¤ì œ Stepì„ ìœ„ì„í•˜ëŠ” ì—­í™œì„ ì²˜ë¦¬í•œë‹¤.

1. TaskletStepBuilder
- ì´ ë¹Œë”ëŠ” ë‹¨ìˆœ Taskletì„ ì‚¬ìš©í•˜ëŠ” Stepì„ ìƒì„±í•©ë‹ˆë‹¤. ê°œë°œìê°€ ì§ì ‘ êµ¬í˜„í•œ Tasklet ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ChunkOrientedTaskletì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

2. SimpleStepBuilder
- ì´ ë¹Œë”ëŠ” Chunk ì§€í–¥ ì²˜ë¦¬ë¥¼ ìœ„í•œ Stepì„ ìƒì„±í•©ë‹ˆë‹¤. ë‚´ë¶€ì ìœ¼ë¡œ ChunkOrientedTaskletì„ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤. ItemReader, ItemProcessor, ItemWriterë¥¼ ì¡°í•©í•˜ì—¬ Chunk ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
3. PartitionStepBuilder : ë©€í‹° ìŠ¤ë ˆë“œ ë°©ì‹ìœ¼ë¡œ Jobì„ ì‹¤í–‰í•œë‹¤.
4. JobStepBuilder : JobStepì„ ìƒì„±í•˜ê³  Stepì•ˆì—ì„œ Jobì„ ì‹¤í–‰í•œë‹¤.
5. FlowStepBuilder : FlowStepì„ ìƒì„±í•˜ì—¬ Stepì•ˆì— Flowë¥¼ ì‹¤í–‰í•œë‹¤.

> ê°ê°ì˜ API íŒŒë¼ë¯¸í„°ì— ë§ê²Œ StepBuilderëŠ” í•˜ìœ„ ë¹Œë” í´ë˜ìŠ¤ì—ê²Œ Step ìƒì„±ì„ ìœ„ì„í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
![img.png](img/3/2.png)


## [Tasklet, Chunk ê·¸ë˜ì„œ ë¨¸ê°€ ë‹¤ë¥¸ë°?]
![img.png](img/3/3.png)
- ì¼ë‹¨ APIì˜ íŒŒë¼ë¯¸í„°ì— ë”°ë¼ì„œ Stepì„ ìƒì„±í•˜ëŠ” ë¹Œë”ê°€ ë‹¤ë¥´ë‹¤. 

**TaskletStepBuilder**
- **TaskletStepBuilder**ì˜ ê²½ìš°ì—ëŠ” ë‹¨ìˆœíˆ Taskletì„ ì‚¬ìš©í•˜ì—¬ ë‹¨ì¼ ì‘ì—…ì„ ì²˜ë¦¬í•œë‹¤.
- í•˜ë‚˜ì˜ Taskletì€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì—ì„œ ë™ì‘í•˜ë©° ë‹¨ìˆœí•œ ì‘ì—…ì— ì ì ˆí•˜ë‹¤.

**SimpleStepBuilder**
- SimpleStepBuilderì€ chunkOrientedTaskletì„ ì‚¬ìš©í•˜ì—¬ Reader, Processor, Writer ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.
- í•˜ë‚˜ì˜ ë©ì–´ë¦¬ë¥¼ nìœ¼ë¡œ ë‚˜ëˆ„ì–´ì„œ ì‹¤í–‰í•˜ëŠ” ì˜ë¯¸ > ëŒ€ëŸ‰ ì²˜ë¦¬ë¥¼ í•˜ëŠ” ê²½ìš° íš¨ê³¼ì ìœ¼ë¡œ ì„¤ê³„ê°€ ê°€ëŠ¥í•˜ë‹¤.


## StartLimit

- Stepì˜ ì‹¤í–‰ íšŸìˆ˜ë¥¼ ì¡°ì •í•  ìˆ˜ ìˆë‹¤.
- Stepë§ˆë‹¤ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
- ì„¤ì • ê°’ì„ ì´ˆê³¼í•´ì„œ ë‹¤ì‹œ ì‹¤í–‰í•˜ë ¤ê³  í•˜ë©´ `StartLimitExceededException`
- start-limitì˜ ë””í´íŠ¸ ê°’ì€ Integer.MAX_VALUE

```java
@Configuration
@Component
public class Step4_2 {

    @Bean
    Job job(JobRepository jobRepository, Step step01, Step step02) {
        return new JobBuilder("step4_2", jobRepository)
                .start(step01)
                .next(step02)
                .build();
    }

    @Bean
    Step step01(JobRepository jobRepository, PlatformTransactionManager transactionManager) {
        return new StepBuilder("step1", jobRepository)
                .tasklet(new Tasklet() {
                    @Override
                    public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {
                        System.out.println("Step 01 start =================");
                        return RepeatStatus.FINISHED;
                    }
                }, transactionManager)
                .build();
    }

    @Bean
    Step step02(JobRepository jobRepository, PlatformTransactionManager transactionManager) {
        return new StepBuilder("step2", jobRepository)
                .tasklet(new Tasklet() {
                    @Override
                    public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {

                        System.out.println("Step02 Start ===================");
                        System.out.println("contribution = " + contribution);
                        System.out.println("chunkContext = " + chunkContext);
                        throw new RuntimeException("step2 exception");
                    }
                }, transactionManager)
                .startLimit(3)
                .build();
    }

}
```

- ì²˜ìŒì— ì‹¤í–‰í•˜ë©´ Step1, Step2ê°€ ì‹¤í–‰, Step2ì—ì„œ Exceptionì´ ë°œìƒí•œë‹¤.
    1.  **`BATCH_JOB_EXECUTION` ì´ fail 1ê°œ ì¶”ê°€ , `BATCH_STEP_EXECUTION` ì€ Step1 ì„±ê³µ Step2 ì‹¤íŒ¨ ìƒì„±, fail ++**
    2.  **`BATCH_JOB_EXECUTION` ì´ fail 1ê°œ ì¶”ê°€ , `BATCH_STEP_EXECUTION` ì€  Step2 ì‹¤íŒ¨ ìƒì„± , fail ++**
    3.  **`BATCH_JOB_EXECUTION` ì´ fail 1ê°œ ì¶”ê°€ , `BATCH_STEP_EXECUTION` ì€  Step2 ì‹¤íŒ¨ ìƒì„±, fail ++**
    4.  Step2ê°€ ì‹¤í–‰ë˜ì§€ ì•Šê³  **`BATCH_JOB_EXECUTION` ì—**`StartLimitExceededException` ë°œìƒ
    5. startLimit(3)ìœ¼ë¡œ ì„¤ì •í•´ì„œ **`BATCH_STEP_EXECUTION` ì´ 3ì´ˆê³¼í•˜ë©´ ë™ì‘ì„ í•˜ì§€ ì•ŠëŠ”ë‹¤.**

### allowStartIfComplete()

- ì¬ì‹œì‘ ê°€ëŠ¥í•œ jobì—ì„œ Stepì˜ ì´ì „ì— ì„±ê³µ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ í•­ìƒ Stepì„ ì‹¤í–‰
- ì‹¤í–‰ ë§ˆë‹¤ ìœ íš¨ì„± ê²€ì¦ì„ í•˜ëŠ” Step / tkwjs wkrdjq
- Completed ìƒíƒœë¥¼ ê°€ì§„ Stepì€ Job ì¬ì‹œì‘ì‹œ ì‹¤í–‰í•˜ì§€ ì•Šê³  ìŠ¤í‚µ, allowstartë¥¼ trueë¡œ ì„¤ì •í•˜ë©´ í•­ìƒ ì‹¤í–‰
![img.png](img/2/4.png)

```java
@Bean
Step step01(JobRepository jobRepository, PlatformTransactionManager transactionManager) {
    return new StepBuilder("step1", jobRepository)// StepBuilderë¥¼ ìƒì„±í•˜ì—¬ Stepì˜ ì´ë¦„ì„ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ëŠ”ë‹¤.
            .tasklet(new Tasklet() {
                @Override
                public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {
                    System.out.println("Step 01 start =================");
                    return RepeatStatus.FINISHED;
                }
            }, transactionManager)
            .allowStartIfComplete(true)
            .build();
}
```

 ìœ„ì— ì½”ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ `allowStartIfComplete(true)` ë¥¼ ì²˜ë¦¬í•˜ë©´ **`BATCH_STEP_EXECUTION` ì€ ì„±ê³µí•œ Step1ì„ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ë‹¤. í•˜ì§€ë§Œ trueë¡œ ì„¤ì •í•˜ë©° Në²ˆì§¸ ëª¨ë‘ Step1 ì´ ì‹¤í–‰ëœë‹¤.**
 
## Flow
- Stepì„ ìˆœì°¨ì ìœ¼ë¡œë§Œ êµ¬ì„±í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ íŠ¹ì •í•œ ìƒíƒœì— ë”°ë¼ íë¦„ì„ ì „í™˜í•˜ë„ë¡ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤.
    - Stepì´ ì‹¤íŒ¨ë¥¼ í•˜ë”ë¼ë„  Jobì€ ì‹¤íŒ¨ë¡œ ëë‚˜ì§€ ì•Šë„ë¡ í•´ì•¼ í•˜ëŠ” ê²½ìš°
    - Stepì´ ì„±ê³µ í–ˆì„ ë•Œ ë‹¤ìŒì— ì‹¤í–‰í•´ì•¼ í•  Stepì„ êµ¬ë¶„í•´ì„œ ì‹¤í–‰í•´ì•¼ í•˜ëŠ” ê²½ìš°
    - íŠ¹ì • Stepì€ ì „í˜€ ì‹¤í–‰ë˜ì§€ ì•Šê²Œ êµ¬ì„± í•´ì•¼ í•˜ëŠ” ê²½ìš°

- Flow, Jobì€ íë¦„ì„ êµ¬ì„±í•˜ê³  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ Stepì—ì„œ ì´ë£¨ì–´ì§„ë‹¤.
    - ë‚´ë¶€ì ìœ¼ë¡œ SimpleFlow ê°ì²´ë¥¼ ê°€ì§€ê³  ìˆì–´  Job ì‹¤í–‰ ì‹œ í˜¸ì¶œí•œë‹¤.
  
![img.png](img/3/4.png)


## FlowJob
```java
@Bean
public Job simpleJobExecution() throws Exception {
    return new JobBuilder("simpleJobExecution", jobRepository)
            .incrementer(new RunIdIncrementer())
            .start(simpleJobExecutionStep_1())
            .on(string Patten) // Stepì˜ exitStatusë¥¼ ë§¤ì¹­ì„ ì‹œì¼œì„œ toì˜ stepìœ¼ë¡œ ì´ë™ì„ ì‹œí‚¨ë‹¤. 
            .to()
            .stop() / fail() / end()/ stopAndRestart() // Flowë¥¼ ì¤‘ì§€ / ì‹¤íŒ¨ / ì¢…ë£Œ í•˜ë„ë¡ Flow ì¢…ë£Œ
            .from() // ì´ì „ ë‹¨ê³„ì—ì„œ ì •ì˜í•œ Stepì˜ Flowë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ì •ì˜í•¨
            .end() // FlowBuilderë¥¼ ì¢…ë£Œí•˜ê³  SimpleFlow ìƒì„±í•œë‹¤.
            .build();
}
```

### exam code
- í•´ë‹¹ ì½”ë“œëŠ” flowStep1ì„ ì‹¤í–‰ì„ ì‹œì¼œì„œ Statusì— ë”°ë¼ì„œ ë‹¤ìŒ Stepì„ ì´ë™ì„ ì‹œí‚¤ê²Œ í•œë‹¤.
- start, nextì— íŒŒë¼ë¯¸í„°ë¡œ step, flowì— ë”°ë¼ì„œ Stepì„ ìƒì„±í•˜ëŠ” Builderê°€ ë‹¤ë¥´ê²Œ ë˜ê³ 
  - stepì„ ë„£ìœ¼ë©´ SimpleFlowBuilderê°€ Flowë¥¼ ë„£ìœ¼ë©´ FlowBuilderê°€ ìƒì„±ë˜ì–´ ì²˜ë¦¬ëœë‹¤.

```java
@Slf4j
@Configuration
@RequiredArgsConstructor
public class FlowJobExam2 {
  private final JobRepository jobRepository;
  private final PlatformTransactionManager transactionManager;

  @Bean
  public Job simpleFlowExam2() throws Exception {
    return new JobBuilder("simpleFlowExam2", jobRepository)
            .incrementer(new RunIdIncrementer())
            .start(firstFlow1())
            .next((flowExamStep3()))
            .on("COMPLETED")
            .to(flowExamStep4())
            .on("COMPLETED")
            .to(flowExamStep5())
            .end()
            .build();
  }

  @Bean
  public Flow firstFlow1() {
    return new FlowBuilder<Flow>("firstFlow1")
            .start(flowExamStep1())
            .next(flowExamStep2())
            .build();
  }
  @Bean
  Step flowExamStep1() {
    return new StepBuilder("flowExamStep1", jobRepository)
            .tasklet((contribution, chunkContext) -> {
              log.info("===============step1 was excuted!===============");
              return RepeatStatus.FINISHED;
            }, transactionManager)
            .build();
  }

  @Bean
  Step flowExamStep2() {
    return new StepBuilder("flowExamStep2", jobRepository)
            .tasklet((contribution, chunkContext) -> {
              log.info("===============step2 was excuted!===============");
              return RepeatStatus.FINISHED;
            }, transactionManager)
            .build();
  }

  @Bean
  Step flowExamStep3() {
    return new StepBuilder("flowExamStep3", jobRepository)
            .tasklet((contribution, chunkContext) -> {
              log.info("===============step3 was excuted!===============");
              return RepeatStatus.FINISHED;
            }, transactionManager)
            .build();
  }

  @Bean
  Step flowExamStep4() {
    return new StepBuilder("flowExamStep4", jobRepository)
            .tasklet((contribution, chunkContext) -> {
              log.info("===============step4 was excuted!===============");
              return RepeatStatus.FINISHED;
            }, transactionManager)
            .build();
  }

  @Bean
  Step flowExamStep5() {
    return new StepBuilder("flowExamStep5", jobRepository)
            .tasklet((contribution, chunkContext) -> {
              log.info("===============step5 was excuted!===============");
              throw new RuntimeException("Step5 Exception Haha");
            }, transactionManager)
            .build();
  }
}


2024-10-16 14:41:12 [INFO ] [] [] Executing step: [flowExamStep1]
2024-10-16 14:41:12 [INFO ] [] [] ===============step1 was excuted!===============
2024-10-16 14:41:12 [INFO ] [] [] Step: [flowExamStep1] executed in 31ms
2024-10-16 14:41:12 [INFO ] [] [] Executing step: [flowExamStep2]
2024-10-16 14:41:12 [INFO ] [] [] ===============step2 was excuted!===============
2024-10-16 14:41:12 [INFO ] [] [] Step: [flowExamStep2] executed in 27ms
2024-10-16 14:41:12 [INFO ] [] [] Executing step: [flowExamStep3]
2024-10-16 14:41:12 [INFO ] [] [] ===============step3 was excuted!===============
2024-10-16 14:41:12 [INFO ] [] [] Step: [flowExamStep3] executed in 20ms
2024-10-16 14:41:12 [INFO ] [] [] Executing step: [flowExamStep4]
2024-10-16 14:41:12 [INFO ] [] [] ===============step4 was excuted!===============
2024-10-16 14:41:12 [INFO ] [] [] Step: [flowExamStep4] executed in 19ms
2024-10-16 14:41:12 [INFO ] [] [] Executing step: [flowExamStep5]
2024-10-16 14:41:12 [INFO ] [] [] ===============step5 was excuted!===============
2024-10-16 14:41:12 [ERROR] [] [] Encountered an error executing step flowExamStep5 in job simpleFlowExam2
java.lang.RuntimeException: Step5 Exception Haha
```
- í•´ë‹¹ ì¿¼ë¦¬ë¥¼ ì‚´í´ë³´ë©´ flowì˜ (step1, step2)ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ì´í›„ step3ê°€ ì‹¤í–‰ > Completeê°€ ë˜ì–´ Step4 > Completeê°€ ë˜ì–´ Step5ì—ì„œ exceptionì´ ë°œìƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

> Flowë¥¼ ì²˜ë¦¬ë¥¼ í•˜ë”ë¼ë„ Jobì—ëŠ” ì‹¤íŒ¨ ì²˜ë¦¬ê°€ ë°œìƒëœë‹¤.
![img.png](img/3/5.png)


<br/>
<br/>

![img.png](img/3_1.png)

- `start, from, next` : í”Œë¡œìš°ì˜ íë¦„ì„ ì •ì˜í•˜ëŠ” ì—­í™œì„ í•˜ë‚Ÿ.
- `on, to, stop, fail` : ì¡°ê±´ì— ë”°ë¼ íë¦„ì„ ì „í™˜í•˜ëŠ” ì—­í™œì„ ìˆ˜í–‰í•œë‹¤.

![img_1.png](img/3_2.png)

### ì „ì²´ì ì¸ íë¦„
1. FlowBuilder 
2. ì²˜ìŒì— Start()
3. ON (ì¡°ê±´)
4. Transitionbulider
5. íŒ¨í„´ì— í•´ë‹¹í•˜ëŠ” API í˜¸ì¶œ
6. return FlowBuilderë¥¼ ë°˜í™˜í•œë‹¤.
7. ë‹¤ì‹œ Stepìœ¼ë¡œ ë„˜ì–´ì™€ì„œ ì²˜ë¦¬í•œë‹¤.

<br/>

## ë°°ì¹˜ ìƒíƒœ ìœ í˜• - Transition

---

### 1. BatchStatus , ExitStatus

- JobExecution, StepExecution ì†ì„±ìœ¼ë¡œ Job, Stepì˜ ìµœì¢… ê²°ê³¼ë¥¼ ì˜ë¯¸í•œë‹¤.


### BatchStatus , ExitStatus ì°¨ì´ì 

- BatchStatus (Job) : ë°°ì¹˜ì˜ í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì¦‰ Jobì˜ ì‹¤í–‰ ì´í›„ ë°°ì¹˜ê°€ ì‹¤í–‰ì¸ì§€ ì¢…ë‹¨ì´ ë˜ì—ˆëŠ”ì§€, ì‹¤íŒ¨ë¥¼ í–ˆëŠ”ì§€ë¥¼ ì˜ë¯¸í•œë‹¤.
- ExitStatus(Step) : Job, Stepì´ ì–´ë–¤ ìƒíƒœë¡œ ì¢…ë£Œë˜ì—ˆëŠ”ì§€ë¥¼ ì˜ë¯¸í•œë‹¤.

[https://www.inflearn.com/questions/865614/batchstatus-ì™€-exitstatus-ì˜-ì°¨ì´ì ì´-ë­”ì§€-ëª¨ë¥´ê² ìŠµë‹ˆë‹¤](https://www.inflearn.com/questions/865614/batchstatus-%EC%99%80-exitstatus-%EC%9D%98-%EC%B0%A8%EC%9D%B4%EC%A0%90%EC%9D%B4-%EB%AD%94%EC%A7%80-%EB%AA%A8%EB%A5%B4%EA%B2%A0%EC%8A%B5%EB%8B%88%EB%8B%A4)

### SimpleJob

- ë§ˆì§€ë§‰ BatchStatusê°’ì„ Jobì˜ ìµœì¢… BatchStatusê°’ìœ¼ë¡œ ë°˜ì˜
- Stepì´ ì‹¤íŒ¨í•  ê²½ìš° í•´ë‹¹ Stepì´ ë§ˆì§€ë§‰ì´ ëœë‹¤.

### FlowJob

- Flow ë‚´ Stepì˜ ExitStatusê°’ì„ FlowExecutionStatus ì €ì¥í•˜ë©° ë§ˆì§€ë§‰ Flowì˜ FlowExecutionStatusê°’ì„ ìµœì¢… BatchStatusê°€ ëœë‹¤.

### 2. FlowExecutionStatus

- FlowExecutionì˜ ì†ì„±ìœ¼ë¡œ Flow ì‹¤í–‰ í›„ ìµœì¢… ê²°ê³¼ ìƒíƒœê°€ ë¬´ì—‡ì´ì§€ ì •ì˜
- Flow ë‚´ Stepì´ ì‹¤í–‰ë˜ê³  ë‚˜ì„œ ExitStatusê°’ì„ FlowExecutionStatusê°’ìœ¼ë¡œ ì €ì¥í•œë‹¤.
- FlowJobì˜ ë°°ì¹˜ ê²°ê³¼ ìƒíƒœì— ê´€ì—¬í•œë‹¤.

> COMPLETED, STOPPED, FAILED, UNKNOWN
>

### 3. Transition

- Flowë‚´ Stepì˜ ì¡°ê±´ë¶€ ì „í™˜ì„ ì •ì˜í•œë‹¤.
- Jobì˜ API ì„¤ì •ì—ì„œ on ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ TrasnsitionBuilderê°€ ë°˜í™˜ë˜ì–´ Trasnsition Flowë¥¼ êµ¬ì„±
- Stepì˜ ExitStatusê°€ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ì˜ˆì™¸ë¥¼ ë°œìƒí•˜ê³  Jobì€ ì‹¤íŒ¨ëœë‹¤.

### API

<aside>
ğŸ’¡ Flowì˜ íë¦„ì„ ê´€ë¦¬í•˜ëŠ” API

</aside>

1. On(String Pattern)

Stepì˜ ExitStatusì™€ Patternì´ ë§¤ì¹­í•˜ë©´ ë‹¤ìŒì— ì‹¤í–‰í•  Stepì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

- íŠ¹ìˆ˜ë¬¸ì
  - * : 0ê°œ ì´ìƒì˜ ë¬¸ìì™€ ë§¤ì¹­ , ëª¨ë“  ExitStatusì™€ ë§¤ì¹­ëœë‹¤.
  - ? : ì •í™•íˆ 1ê°œì˜ ë¬¸ìì™€ ë§¤ì¹­
    - c*tëŠ” cat, count ë§¤ì¹­ë˜ê³ , c?tëŠ” catì—ë§Œ ë§¤ì¹­ëœë‹¤.

1. to()

ë‹¤ìŒìœ¼ë¡œ ì‹¤í–‰í•  ë‹¨ê³„ë¥¼ ì§€ì •

1. from

ì´ì „ ë‹¨ê³„ì—ì„œ ì •ì˜í•œ Transitionì„ ìƒˆë¡­ê²Œ ì¶”ê°€ ì •ì˜í•¨

<aside>
ğŸ’¡ Jobì„ ì¤‘ë‹¨, ì¢…ë£Œí•˜ëŠ” API                                                                                                                                                                                        - Flowê°€ ì‹¤í–‰ë˜ë©´ FlowExecutionStatusì— ìƒíƒœê°’ì´ ì €ì¥ë˜ê³  Jobì˜ Batch, ExitStatusì— ë°˜ì˜í•œë‹¤.                       Stepì˜ Batch, ExitStatusì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  Jobì˜ ìƒíƒœë§Œ ë³€ê²½í•œë‹¤.

</aside>

1. Stop

FlowExecutionStatus, BatchStatus, ExitStatusë¥¼ STOPPEDë¡œ ì¢…ë£Œë¥¼ ì‹œí‚¨ë‹¤.

1. fail

FlowExecutionStatus, BatchStatus, ExitStatusë¥¼ FAILEDë¡œ ì¢…ë£Œë¥¼ ì‹œí‚¨ë‹¤.

6.end

FlowExecutionStatus, BatchStatus, ExitStatusë¥¼ COMPLETEDë¡œ ì¢…ë£Œë¥¼ ì‹œí‚¨ë‹¤.

- Stepì˜ EXitStatusê°€ FAILEDì´ë”ë¼ë„ JOBì˜ BATCHSTATUSê°€ COMPLETEDë¡œ ì¢…ë£Œ
- JOBì˜ ì¬ì‹œì‘ì„ ë¶ˆê°€ëŠ¥í•˜ê²Œ ë§Œë“ ë‹¤.

1. stopAndRestart

stopê³¼ ë¹„ìŠ·í•˜ì§€ë§Œ íŠ¹ì • stepì‘ì—…ì„ ì¤‘ë‹¨í•˜ê³  ì´ì „ stepì€ completedë¡œ ì €ì¥ì„ í•˜ê³  íŠ¹ì • stepì„ STOPPED ì €ì¥

jobì´ ë‹¤ì‹œ ì‹¤í–‰í•  ë•Œ stepì„ restartì¸ìë¡œ ë„˜ê¸°ë©´ ì´ì „ì— completed ìŠ¤íƒ­ì„ ê±´ë„ˆë›°ê³  STOPPEDë¶€í„° ì‹œì‘í•œë‹¤.

## 3. ExitStatus

---

- Job, Stepì´ ì–´ë–¤ ìƒíƒœë¡œ ì¢…ë£Œê°€ ë˜ì—ˆëŠ”ì§€ ì˜ë¯¸
- StepExecutionListenerì˜ afterStep ë©”ì„œë“œì˜ Custom exitCode ìƒì„± í›„ ìƒˆë¡œìš´ ExitStatus ë°˜í™˜

```java

@Bean
public Job flowJob(JobRepository jobRepository, PlatformTransactionManager transactionManager) {
    return new JobBuilder("batchJob", jobRepository)
            .incrementer(new RunIdIncrementer())
            .start(step1(jobRepository, transactionManager))
            .on(DEFAILT_ENUM.FAILED.getValue())
            .to(step2(jobRepository, transactionManager))
            .on("CUSTOM_EXIT_STATUS_CODE")
            .stop()
            .end()
            .build();
}

@Bean
public Step step1(JobRepository jobRepository, PlatformTransactionManager transactionManager) {
    return new StepBuilder("step1", jobRepository)
            .tasklet(new Tasklet() {
                @Override
                public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {
                    contribution.setExitStatus(ExitStatus.FAILED);
                    System.out.println("start step1 hello world");
                    return RepeatStatus.FINISHED;
                }
            }, transactionManager)
            .build();
}

@Bean
public Step step2(JobRepository jobRepository, PlatformTransactionManager transactionManager) {
    return new StepBuilder("step2", jobRepository)
            .tasklet(new Tasklet() {
                @Override
                public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {
                    System.out.println("start step2 hello world");
                    return RepeatStatus.FINISHED;
                }
            }, transactionManager)
            .build();
}

@Bean
public Step step3(JobRepository jobRepository, PlatformTransactionManager transactionManager) {
    return new StepBuilder("step3", jobRepository)
            .tasklet(new Tasklet() {
                @Override
                public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {
                    System.out.println("start step3 hello world");
                    return RepeatStatus.FINISHED;
                }
            }, transactionManager)
            .build();
}
```

**`BATCH_JOB_EXECUTION` ì„ ì‚´í´ë³´ë©´ statusê°€ ëª¨ë‘ FAILEDê°€ ë‚˜ì˜¨ë‹¤.**

- ì´ë ‡ê²Œ ë‚˜ì˜¨ ì´ìœ ëŠ” step2ê°€ `CUSTOM_EXIT_STATUS_CODE` ì¸ë° successê°€ ë˜ê¸° ë•Œë¬¸ì— stopì„ ì‹¤í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.
  - ì´ë ‡ê²Œ flowë’¤ì— ì‹¤íŒ¨ê°€ ë˜ê³  .end()ë¥¼ í•˜ë©´ ìŠ¤í”„ë§ ìì²´ì—ì„œ FAILEDë¥¼ JOB_Executionì— FAILEDë¡œ ë§Œë“¬

<aside>
ğŸ’¡ JOB_EXECUTIONì€ ë§ˆì§€ë§‰ ìƒíƒœì— ëŒ€í•´ì„œ ì €ì¥ì„ í•˜ëŠ”ë° STEP2ëŠ” ì„±ê³µìœ¼ë¡œ ë‚˜ì˜¨ë‹¤.

</aside>

```java
[
  {
    "STATUS": "FAILED",
    "EXIT_CODE": "FAILED"
  }
]
```

**`BATCH_STEP_EXECUTION`**
```java
[
  {
    "STATUS": "COMPLETED",
    "EXIT_CODE": "FAILED"
  },
  {
    "STATUS": "COMPLETED",
    "EXIT_CODE": "COMPLETED"
  }
]
```

- í˜„ì¬ step1ì€ FAILì´ ë‚˜ì˜¤ê³  STEP2ëŠ” COMPLETEDê°€ ë‚˜ì˜¨ë‹¤.
- ê¸°ì¡´ì— ìƒê°ì€ step2ê°€ customì´ ì•„ë‹ˆë‹ˆê¹ failì´ ë‚˜ì˜¨ë‹¤ê³  ìƒê°í–ˆì§€ë§Œ step2ì˜ ì½”ë“œëŠ” onì„ ì‹¤í–‰í•˜ê¸° ì´ì „ì— ìˆ˜í–‰í•œë‹¤.

<Br/>

## FlowStep

- Step ë‚´ì—ì„œ Flowë¥¼ í• ë‹¹í•˜ì—¬ ì‹¤í–‰ì„ ì‹œí‚¤ëŠ” ë„ë©”ì¸ ê°ì²´ì´ë‹¤. ì´ë•Œ flowStepì—ì„œëŠ” BatchStatusì™€ ExitStatusì€ Flowì˜ ìµœì¢… ìƒíƒœê°’ì— ë”°ë¼ ê²°ì •ì´ ëœë‹¤.